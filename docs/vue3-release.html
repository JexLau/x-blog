<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
      纪年 |【第三期】Vue3 Release 源码解读记录 | 纪年
    </title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/blog/_assets/style.282607dd.css">
    <link rel="modulepreload" href="/blog/_assets/common-bec3f312.js">
    <link rel="modulepreload" href="/blog/_assets/docs_vue3-release.md.6c18248d.lean.js">
    <link rel="modulepreload" href="/blog/_assets/app.c2a4d5fc.js">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="keywords" content="纪年">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://lib.baomitu.com/gitalk/1.7.0/gitalk.min.css">
    <script src="https://lib.baomitu.com/gitalk/1.7.0/gitalk.min.js"></script>
    <script src="https://lib.baomitu.com/axios/0.21.1/axios.js"></script>
    
  </head>
  <body>
    <div id="app"><!--[--><div id="containerColor" class="no-sidebar theme" data-v-1880a9f7><header class="navbar" data-v-1880a9f7><!--[--><a class="title" aria-label="纪年, back to home" href="/blog/"><img class="logo" src="/blog/favicon.ico" alt="logo"><span>纪年</span></a><div class="flex-grow"></div><nav class="nav-links hide-mobile" data-v-1880a9f7><!--[--><!--[--><div class="nav-item" data-v-1880a9f7><a class="nav-link" href="/blog/index.html" target="" rel="">🏠 首页 <!----></a></div><!--]--><!--[--><div class="nav-item" data-v-1880a9f7><a class="nav-link" href="/blog/more/docs.html" target="" rel="">📅 归档 <!----></a></div><!--]--><!--[--><div class="nav-item" data-v-1880a9f7><a class="nav-link" href="/blog/more/tags.html" target="" rel="">📂 分类 <!----></a></div><!--]--><!--[--><div class="nav-item" data-v-1880a9f7><a class="nav-link" href="/blog/more/Friendship.html" target="" rel="">👫 友情链接 <!----></a></div><!--]--><!--]--><!----><!----></nav><!--[--><!--[--><!--]--><!--]--><!--]--><div class="sidebar-button" data-v-1880a9f7><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div></header><aside class="" data-v-1880a9f7><!--[--><nav class="nav-links show-mobile" data-v-1880a9f7><!--[--><!--[--><div class="nav-item" data-v-1880a9f7><a class="nav-link" href="/blog/index.html" target="" rel="">🏠 首页 <!----></a></div><!--]--><!--[--><div class="nav-item" data-v-1880a9f7><a class="nav-link" href="/blog/more/docs.html" target="" rel="">📅 归档 <!----></a></div><!--]--><!--[--><div class="nav-item" data-v-1880a9f7><a class="nav-link" href="/blog/more/tags.html" target="" rel="">📂 分类 <!----></a></div><!--]--><!--[--><div class="nav-item" data-v-1880a9f7><a class="nav-link" href="/blog/more/Friendship.html" target="" rel="">👫 友情链接 <!----></a></div><!--]--><!--]--><!----><!----></nav><!--[--><!--[--><!--]--><!--]--><ul class="sidebar"><!--[--><!--]--></ul><!--[--><!--[--><!--]--><!--]--><!--]--></aside><!----><!-- TODO: make this button accessible --><div class="sidebar-mask" data-v-1880a9f7></div><main data-v-1880a9f7><!--[--><div class="content"><!--[--><!--[--><!--]--><!--]--><div class="md-header"><div class="md-title">纪年 |【第三期】Vue3 Release 源码解读记录</div><span id="jinrishici-sentence">正在加载今日诗词....</span><div class="md-date">2021-08-25</div></div><ul class="catalog"><!--[--><li class="catalog-item"><a class="level level-2" href="#_1-学习目标和资源准备">1. 学习目标和资源准备</a><!----></li><li class="catalog-item"><a class="level level-2" href="#_2-yarn-workspace">2. Yarn Workspace</a><!----></li><li class="catalog-item"><a class="level level-2" href="#_3-release-js-文件解读">3. release.js 文件解读</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#main-函数">main 函数</a></li><li class="catalog-item"><a class="level level-2" href="#_4-感想">4. 感想</a><!----></li><li class="catalog-item"><a class="level level-2" href="#_5-实践">5. 实践</a><!----></li><!--]--></ul><div data-v-1880a9f7><blockquote><p>【若川】Vue3 Release 源码解读：<a href="https://juejin.cn/post/6997943192851054606" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6997943192851054606</a></p></blockquote><h2 id="_1-学习目标和资源准备"><a class="header-anchor" href="#_1-学习目标和资源准备" aria-hidden="true">#</a> 1. 学习目标和资源准备</h2><p>这一期阅读的是 Vue3 源码中的 script/release.js 代码，也就是 Vue.js 的发布流程。在上一期源码阅读中从 <a href="https://github.com/vuejs/vue-next/blob/master/.github/contributing.md" target="_blank" rel="noopener noreferrer">.github/contributing.md</a> 了解到 Vue.js 采用的是 monorepo 的方式进行代码的管理。</p><p>monorepo 是管理项目代码的一个方式，指在一个项目仓库 (repo) 中管理多个模块/包 (package)，不同于常见的每个 package 都建一个 repo。</p><p>刚好我最近搭建组件库也是使用 monorepo 的方式去管理包。 monorepo 有个缺点，因为每个包都维护着自己的 dependencies，那么在 install 的时候会导致 node_modules 的体积非常大。目前最常见的 monorepo 解决方案是使用 lerna 和 yarn 的 workspaces 特性去处理仓库的依赖，我搭建的组件库也是使用了 lerna 和 yarn。但 Vue3 的包管理没有使用 lerna，它是怎么管理依赖包的版本号呢？让我们跟着源码一探究竟。</p><blockquote><p><a href="https://www.lernajs.cn/" target="_blank" rel="noopener noreferrer">Lerna</a> 是一个管理工具，用于管理包含多个软件包（package）的 JavaScript 项目，针对使用 git 和 npm 管理多软件包代码仓库的工作流程进行优化。</p></blockquote><p><strong>学习目标：</strong></p><p>1）学习 release.js 源码，输出记录文档。</p><p><strong>资源准备：</strong></p><p>Vue3 源码地址：<code>https://github.com/vuejs/vue-next</code></p><h2 id="_2-yarn-workspace"><a class="header-anchor" href="#_2-yarn-workspace" aria-hidden="true">#</a> 2. Yarn Workspace</h2><div class="language-typescript"><pre><code><span class="token comment">// vue-next/package.json （多余的代码已省略）</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.2.2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;workspaces&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;packages/*&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;release&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node scripts/release.js&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Yarn 从 1.0 版开始支持 Workspace （工作区），Workspace 可以更好的统一管理有多个项目的仓库。</p><ul><li>管理依赖关系便捷：每个项目使用独立的 package.json 管理依赖，可以使用 yarn 命令一次性安装或者升级所有依赖，无需在每个目录下分别安装依赖</li><li>降低磁盘空间占用：可以使多个项目共享同一个 node_modules 目录</li></ul><h2 id="_3-release-js-文件解读"><a class="header-anchor" href="#_3-release-js-文件解读" aria-hidden="true">#</a> 3. release.js 文件解读</h2><p>先手动跑一遍 <code>yarn run release --dry</code>，控制台会输出以下信息（多余信息已省略），从控制台日志看出来，发布 Vue.js 会经历以下几个步骤：</p><div class="language-"><pre><code>// 确认发布版本号
? Select release type ... 
&gt; patch (3.2.3)
  minor (3.3.0)
  major (4.0.0)
  custom
// 执行测试用例
Running tests...
// 更新依赖版本
Updating cross dependencies...
// 打包编译所有包
Building all packages...
// 生成 changelog
conventional-changelog -p angular -i CHANGELOG.md -s
// 提交代码
Committing changes...
// 发布包
Publishing packages...
// 推送代码到 GitHub
Pushing to GitHub...
</code></pre></div><p>初步了解发布流程后，来看看 release.js 源码做了什么，先看入口函数 main()</p><h3 id="main-函数"><a class="header-anchor" href="#main-函数" aria-hidden="true">#</a> main 函数</h3><p>代码太多就不贴代码了，记录一下思路和思考</p><ol><li>确认要发布的版本：</li></ol><ul><li><ul><li>如果从命令行获取到了版本号，先验证版本号规范，再次确认版本号</li><li>如果命令行没有输入版本号，会让用户选择一个版本发布</li></ul></li></ul><p>确认版本号使用了一个库叫 <strong>semver</strong>，它的作用是用于版本校验比较。</p><div class="language-js"><pre><code><span class="token comment">// 目的是获取命令行参数（也就是允许用户自定义输入版本号，比如 yarn release v3.5.0）</span>
<span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;minimist&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> targetVersion <span class="token operator">=</span> args<span class="token punctuation">.</span>_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><ol start="2"><li>执行测试用例</li></ol><div class="language-js"><pre><code><span class="token keyword">const</span> execa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;execa&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">bin<span class="token punctuation">,</span> args<span class="token punctuation">,</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execa</span><span class="token punctuation">(</span>bin<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token operator">:</span> <span class="token string">&#39;inherit&#39;</span><span class="token punctuation">,</span> <span class="token operator">...</span>opts <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">bin</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;../node_modules/.bin/&#39;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skipTests <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isDryRun<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// bin(&quot;jest&quot;) 先获取 node_modules/.bin/jest 的目录，run 的本质就是执行命令行</span>
  <span class="token comment">// 这行代码的意思就相当于在命令终端，项目根目录运行 ./node_modules/.bin/jest 命令。</span>
  <span class="token keyword">await</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token function">bin</span><span class="token punctuation">(</span><span class="token string">&#39;jest&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;--clearCache&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token string">&#39;yarn&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;test&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;--bail&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(skipped)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>更新依赖版本</li></ol><div class="language-js"><pre><code><span class="token comment">// 1）获取 packages 目录下的所有包</span>
<span class="token keyword">const</span> packages <span class="token operator">=</span> fs
  <span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;../packages&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;.ts&#39;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 1）获取包的根目录路径</span>
<span class="token keyword">const</span> <span class="token function-variable function">getPkgRoot</span> <span class="token operator">=</span> <span class="token parameter">pkg</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;../packages/&#39;</span> <span class="token operator">+</span> pkg<span class="token punctuation">)</span>
<span class="token comment">// 2）更新根目录和 packages 目录下每个包的 package.json 的版本号</span>
<span class="token keyword">function</span> <span class="token function">updateVersions</span><span class="token punctuation">(</span><span class="token parameter">version</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// 3）实现更新 package.json 版本号的，以及更新依赖包的版本号</span>
<span class="token keyword">function</span> <span class="token function">updatePackage</span><span class="token punctuation">(</span><span class="token parameter">pkgRoot<span class="token punctuation">,</span> version</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// 4）实现更新与 vue 相关依赖包的版本号</span>
<span class="token keyword">function</span> <span class="token function">updateDeps</span><span class="token punctuation">(</span><span class="token parameter">pkg<span class="token punctuation">,</span> depType<span class="token punctuation">,</span> version</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>打包编译所有包</li></ol><p>这部分涉及另外一个文件 script/build.js，这个文件主要是将各个包打包在对应的目录下，比如打包一个依赖就运行一次<code>yarn build</code>，如果有多个包，就异步循环调用打包命令。核心代码如下：</p><div class="language-javascript"><pre><code><span class="token comment">/**
 * 迭代打包
 * @param {*} maxConcurrency 最大并发
 * @param {*} source 目录
 * @param {*} iteratorFn 构建函数（核心就是运行 build 命令）
 * @returns
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runParallel</span><span class="token punctuation">(</span><span class="token parameter">maxConcurrency<span class="token punctuation">,</span> source<span class="token punctuation">,</span> iteratorFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> executing <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">iteratorFn</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>maxConcurrency <span class="token operator">&lt;=</span> source<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> e <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> executing<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>executing<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      executing<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executing<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> maxConcurrency<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span>executing<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>生成 CHANGELOG 文件</li></ol><p>主要运行的是这行命令：conventional-changelog -p angular -i <a href="http://CHANGELOG.md" target="_blank" rel="noopener noreferrer">CHANGELOG.md</a> -s</p><ol start="6"><li>提交代码</li></ol><p>先执行 git diff 命令，检查文件是否有修改，如果有，执行 git add 和 git commit 命令</p><ol start="7"><li>发布包</li></ol><p>最后执行的命令是，yarn publish，发布新版本和打 Tag</p><ol start="8"><li>推送到 GitHub</li></ol><p>主要运行的命令：</p><ul><li><ul><li>打 tag：git tag ${version}</li><li>推送 tag：git push origin refs/tags/${version}</li></ul></li><li><ul><li>提交代码到远程仓库：git push</li></ul></li></ul><p>至此，release 发布流程已经分析完了。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/1105483/1629654601778-17189d93-a9ad-447f-9ea0-70499c538a0e.jpeg" alt="release 发布流程"></p><h2 id="_4-感想"><a class="header-anchor" href="#_4-感想" aria-hidden="true">#</a> 4. 感想</h2><p>回答一下开篇的问题，Vue 是如何管理版本号呢？阅读完源码我们会分现，在发版的时候会<strong>统一更新所有包的 package.json 的版本号</strong>。对比我在搭建组件库过程中使用的 lerna，其实 lerna 是把 release 这一套流程封装成了一个包，它里面处理发包的流程跟 Vue Release 流程基本是一致的。</p><p>这次的源码解读解答了我的一些疑惑。在我搭建组件库的过程中，我一开始了解到的是一个组件一个目录，单包推送到 npm 私库。这样做的缺点很明显，需要在每个目录安装一遍依赖，单独处理版本号。后来了解到了 yarn workspace，知道它可以处理依赖安装的问题，但版本号的处理还是没有解决方案。于是我去寻找业内比较流行的解决办法，发现大部分是使用了 lerna。</p><p>于是我向我的 TL 沟通询问，可否采用 yarn + lerna 的方式来搭建组件库。我记得特别清楚他反问我，问我 lerna 解决了什么问题，我支支吾吾回答了官网上的介绍，因为我当时对 lerna 的了解仅停留在官网以及它的常用命令，实际上我不知道它解决了什么问题。TL 见我答不上来，回复了我一句【如无必要，勿增实体】。</p><p>通过这次的源码阅读，我可以回答 TL 反问我的那个问题了，lerna 解决的是发包流程中版本号处理，自动生成 CHANGELOG 文件，提交代码，发布包，推送到仓库这几个问题，它把这几个流程封装成命令供用户使用。它不是搭建组件库非必要引入的工具，虽然引用了 lerna 会增加了新的复杂度，但在不了解发包流程的前期使用 lerna 可以使组件库开发者更专注于组件开发的工作上，而不需要过度关注如何发包。</p><h2 id="_5-实践"><a class="header-anchor" href="#_5-实践" aria-hidden="true">#</a> 5. 实践</h2><p>经过一番思考，我认为引入 lerna 确实给系统增加了一些复杂度，因为它要求开发人员额外学习 lerna 的一些知识和命令，增加了学习成本以及系统复杂度。我觉得可以参考 Vue 的 release.js，写一个适用于项目的构建发版脚本用来发包，降低系统复杂度。</p><p>逻辑代码基本与 Vue3 的 release.js 和 build.js 一致，去掉了一些没必要的代码，比如单元测试和一些环境判断。还修改了一下 rollup.config.js 的配置，感觉用起来确实比 lerna 好用一些。最终效果如下：</p><p><img src="/blog/_assets/vue3-release0.f3d9178b.png" alt=""></p><div id="gitalk-container" data-v-1880a9f7></div></div><div class="links-wrapper" data-v-1880a9f7><div class="prev-link"><!----></div><div class="next-link"><!----></div></div><div data-v-1880a9f7><footer class="page-edit"><!--[--><a key="0" href="https://juejin.cn/user/3175045313607534"><img class="imgIcon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC"></a><!--]--></footer><p class="platform"> 以上皆为 <a href="javascript:;">纪年</a> 文章发布平台 </p><p class="platform"> Copyright © 2020-2021 <a href="https://github.com/jexlau">@JexLau</a></p></div><!--[--><!--[--><!--]--><!--]--></div><!-- 只想点击背景才关闭 请使用 .self 修饰符 --><div style="display:none;" class="imgBox"><img src=""></div><!--]--></main><div class="theme-select" data-v-1880a9f7><ul data-v-1880a9f7><li class="active" data-v-1880a9f7>☀️</li><li class="" data-v-1880a9f7>🌑</li></ul></div></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"a49591c5\",\"README.md\":\"c858e745\",\"docs_co.md\":\"087aba0c\",\"docs_launch-editor.md\":\"7e6887da\",\"docs_vue3-release.md\":\"6c18248d\",\"docs_vue3-utils.md\":\"4d30142a\",\"more_docs.md\":\"4b1bb4bd\",\"more_Friendship.md\":\"a5324780\",\"more_index.md\":\"253ee8a1\",\"more_tags.md\":\"004183e3\"}")</script>
    <script type="module" async src="/blog/_assets/app.c2a4d5fc.js"></script>
  </body>
</html>